<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gallery | Hyeri</title>
    <link rel="icon" href="icon/icon.png" type="image/png">
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@300;400&family=Playfair+Display:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <div class="cursor-dot"></div>
    <div class="cursor-outline"></div>

    <header class="fixed-header">
        <div class="header-inner">
            <a href="index.html" class="logo">HYERI.</a>
            <a href="index.html" style="text-transform:uppercase; font-size:0.8rem; letter-spacing:2px;">Back Home</a>
        </div>
    </header>

    <main>
        <section class="gallery-hero">
            <div class="container">
                <h1>Visual Archives</h1>
                <p>Curated Moments</p>
            </div>
        </section>

        <section class="container">
            <!-- Slider Area -->
            <div class="slider-wrapper" id="sliderWrapper" style="display:none;">
                <div class="slider-track" id="sliderTrack"></div>
                <div class="slider-controls">
                    <button class="slider-btn" id="prevBtn">←</button>
                    <button class="slider-btn" id="nextBtn">→</button>
                </div>
            </div>

            <!-- Masonry Grid -->
            <div id="loading" style="text-align:center; margin: 50px 0; color:#666;">Loading Archive...</div>
            <div class="masonry-grid" id="masonryGrid"></div>
        </section>
    </main>

    <!-- Logic -->
    <script src="https://unpkg.com/@studio-freight/lenis@1.0.29/dist/lenis.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="js/app.js"></script>

    <script>
        // --- API & SLIDER LOGIC ---
        const API_URL = 'https://api.hyeri.us.kg';
        const SLIDER_FOLDER = '/hyerigallery/';
        const MASONRY_FOLDER = '/leehyeri/';
        
        // Slider Variables
        let sliderImages = [];
        let currentIndex = 1; // 从1开始，因为0是克隆的最后一张
        let slideInterval;
        const track = document.getElementById('sliderTrack');
        const duration = 2500; // 自动播放间隔 2.5秒
        let isTransitioning = false;

        async function initPage() {
            try {
                const res = await fetch(API_URL);
                const data = await res.json();
                if(!data.success) return;

                // 1. Setup Slider (Infinite Loop Logic)
                const rawImages = data.images.filter(url => url.includes(SLIDER_FOLDER));
                if(rawImages.length > 0) {
                    document.getElementById('sliderWrapper').style.display = 'block';
                    
                    // 构建 slides 数组：[克隆最后一张, 原图1, 原图2..., 原图N, 克隆第一张]
                    const firstImg = rawImages[0];
                    const lastImg = rawImages[rawImages.length - 1];
                    
                    // 添加克隆的最后一张 (放在最前)
                    addSlide(lastImg, 'clone-last');
                    
                    // 添加所有原图
                    rawImages.forEach(url => addSlide(url, 'original'));
                    
                    // 添加克隆的第一张 (放在最后)
                    addSlide(firstImg, 'clone-first');

                    sliderImages = document.querySelectorAll('.slider-slide');
                    
                    // 初始化位置（瞬间跳到真正的第一张）
                    track.style.transition = 'none';
                    track.style.transform = `translateX(-${currentIndex * 100}%)`;

                    // 按钮事件
                    document.getElementById('nextBtn').addEventListener('click', () => {
                        stopAutoPlay();
                        nextSlide();
                        startAutoPlay();
                    });
                    document.getElementById('prevBtn').addEventListener('click', () => {
                        stopAutoPlay();
                        prevSlide();
                        startAutoPlay();
                    });

                    // 开启自动播放
                    startAutoPlay();
                    
                    // 鼠标悬停暂停
                    document.getElementById('sliderWrapper').addEventListener('mouseenter', stopAutoPlay);
                    document.getElementById('sliderWrapper').addEventListener('mouseleave', startAutoPlay);
                }

                // 2. Setup Masonry
                const masonryImages = data.images.filter(url => url.includes(MASONRY_FOLDER));
                const grid = document.getElementById('masonryGrid');
                document.getElementById('loading').style.display = 'none';
                
                masonryImages.forEach(url => {
                    const div = document.createElement('div');
                    div.className = 'masonry-item';
                    const img = document.createElement('img');
                    img.src = url;
                    img.loading = 'lazy';
                    img.onload = () => img.classList.add('loaded');
                    div.appendChild(img);
                    grid.appendChild(div);
                });

            } catch(e) { console.error(e); }
        }

        function addSlide(url, type) {
            const div = document.createElement('div');
            div.className = 'slider-slide';
            div.dataset.type = type;
            div.innerHTML = `<img src="${url}" alt="Slide" style="width:100%; height:100%; object-fit:cover;">`;
            track.appendChild(div);
        }

        function updateSlider() {
            track.style.transition = 'transform 0.8s cubic-bezier(0.2, 1, 0.3, 1)';
            track.style.transform = `translateX(-${currentIndex * 100}%)`;
        }

        function nextSlide() {
            if (isTransitioning) return;
            isTransitioning = true;
            currentIndex++;
            updateSlider();
            
            // 监听过渡结束，处理循环
            track.addEventListener('transitionend', () => {
                isTransitioning = false;
                // 如果到了最后一张（克隆的第一张）
                if (currentIndex === sliderImages.length - 1) {
                    track.style.transition = 'none'; // 关闭动画
                    currentIndex = 1; // 瞬间跳回真正的第一张
                    track.style.transform = `translateX(-${currentIndex * 100}%)`;
                }
            }, { once: true });
        }

        function prevSlide() {
            if (isTransitioning) return;
            isTransitioning = true;
            currentIndex--;
            updateSlider();

            track.addEventListener('transitionend', () => {
                isTransitioning = false;
                // 如果到了第一张（克隆的最后一张）
                if (currentIndex === 0) {
                    track.style.transition = 'none'; // 关闭动画
                    currentIndex = sliderImages.length - 2; // 瞬间跳回真正的最后一张
                    track.style.transform = `translateX(-${currentIndex * 100}%)`;
                }
            }, { once: true });
        }

        function startAutoPlay() {
            // 清除之前的定时器，防止叠加
            if(slideInterval) clearInterval(slideInterval);
            slideInterval = setInterval(nextSlide, duration);
        }

        function stopAutoPlay() {
            clearInterval(slideInterval);
        }

        initPage();
    </script>
</body>
</html>