<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visual Archive | HYERI × HYEROOMY</title>
    <link rel="icon" href="icon/icon.png" type="image/png">
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@300;400&family=Playfair+Display:ital,wght@0,400;0,600&display=swap" rel="stylesheet">
    
    <!-- CSS -->
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <!-- Header -->
    <header class="fixed-header">
        <div class="header-inner">
            <a href="index.html" class="logo">HYERI.</a>
            <a href="index.html" style="text-transform:uppercase; font-size:0.8rem; letter-spacing:2px;">Back Home</a>
        </div>
    </header>

    <main>
        <!-- 无缝滚动跑马灯 (替代原来的 Slider) -->
        <div class="marquee-container">
            <div class="marquee-track" id="marqueeTrack">
                <!-- JS 会在这里填入双倍图片 -->
            </div>
        </div>
        <!-- 标题区域 -->
        <section class="gallery-hero">
            <div class="container">
                <h1>Visual Archives</h1>
                <p>Curated Moments of Lee Hyeri</p>
            </div>
        </section>

        <!-- 瀑布流区域 -->
        <section class="container">
            <div class="masonry-grid" id="masonryGrid">
                <!-- Javascript will render images here -->
            </div>

            <!-- 加载状态提示 -->
            <div id="loadMoreTrigger">
                <span id="triggerText">Scroll to Explore</span>
            </div>
        </section>
    </main>

    <!-- Footer -->
    <footer>
        <p class="copyright">&copy; 2026 HYERI × HYEROOMY | Unofficial Fan Site | Made with love.</p>
    </footer>

    <!-- 返回顶部 -->
    <button id="backToTop" class="back-to-top" aria-label="Back to Top">
        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M12 4L12 20M12 4L6 10M12 4L18 10" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
    </button>

    <!-- Libraries -->
    <script src="https://unpkg.com/@studio-freight/lenis@1.0.29/dist/lenis.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="js/app.js"></script>

    <!-- Gallery 专用逻辑 -->
    <script>
        const CONFIG = {
            apiUrl: 'https://api1.hyeri.us.kg', 
            marqueePrefix: 'hyerigallery', 
            masonryPrefix: 'leehyeri'
        };

        let masonryCursor = null;
        let isMasonryLoading = false;
        let masonryHasMore = true;
        let observer;

        // 初始化
        async function initGallery() {
            loadMarquee();   // 加载顶部跑马灯
            initMasonry();   // 加载瀑布流
        }

        // 1. 加载跑马灯
       async function loadMarquee(desktopSpeed = 10, mobileSpeed = 6) {
    const track = document.getElementById('marqueeTrack');
    if (!track) return;

    try {
        const res = await fetch(`${CONFIG.apiUrl}?prefix=${CONFIG.marqueePrefix}/`);
        const data = await res.json();
        
        if (data.success && data.images.length > 0) {
            const imgs = data.images;
            
            // 1. 生成一组图片的 HTML
            const imgHtml = imgs.map(src => `
                <div class="marquee-item"><img src="${src}" alt=""></div>
            `).join('');
            
            // 2. 【关键】直接复制 3 组，确保无论屏幕多宽，内容都能填满且有冗余
            // 复制 3 组后，位移要改为 -33.33%
            track.innerHTML = imgHtml + imgHtml + imgHtml;

            // 3. 处理速度：根据设备宽度判断秒数
            const isMobile = window.innerWidth < 768;
            const finalDuration = isMobile ? mobileSpeed : desktopSpeed;
            
            // 4. 等待所有图片加载完成后再开始动画（防止计算跳动）
            const allImgs = track.querySelectorAll('img');
            let loadedCount = 0;
            
            const startAnimation = () => {
                loadedCount++;
                if (loadedCount >= allImgs.length) {
                    track.style.animation = `marquee-scroll ${finalDuration}s linear infinite`;
                }
            };

            allImgs.forEach(img => {
                if (img.complete) startAnimation();
                else img.onload = startAnimation;
            });
        }
    } catch (e) { console.error("Marquee Error:", e); }
}

// 调用时直接传秒数：第一个数字是电脑，第二个是手机
async function initGallery() {
    await loadMarquee(5, 3); // 电脑 5秒一圈，手机 3秒一圈（你可以随便改这两个数字）
    initMasonry();
}
        // 2. 瀑布流分页加载
        function initMasonry() {
            loadMasonryBatch();
            const trigger = document.getElementById('loadMoreTrigger');
            observer = new IntersectionObserver((entries) => {
                if (entries[0].isIntersecting && !isMasonryLoading && masonryHasMore) {
                    loadMasonryBatch();
                }
            }, { rootMargin: '300px' });
            observer.observe(trigger);
        }

        async function loadMasonryBatch() {
    if (isMasonryLoading || !masonryHasMore) return;
    isMasonryLoading = true;
    
    const triggerText = document.getElementById('triggerText');
    if(triggerText) triggerText.innerText = "Loading...";

    try {
        const url = new URL(CONFIG.apiUrl);
        url.searchParams.set('prefix', CONFIG.masonryPrefix + '/');
        if (masonryCursor) url.searchParams.set('cursor', masonryCursor);

        const res = await fetch(url);
        const data = await res.json();

        if (data.success) {
            const grid = document.getElementById('masonryGrid');
            
            data.images.forEach(src => {
                const div = document.createElement('div');
                div.className = 'masonry-item';
                
                // 重点：Safari 兼容性处理
                const img = new Image();
                img.src = src;
                img.loading = "lazy"; // 依然保留延迟加载
                
                const showImg = () => img.classList.add('loaded');
                
                // 如果图片已经在缓存里，立刻显示
                if (img.complete) {
                    showImg();
                } else {
                    img.onload = showImg;
                }

                div.appendChild(img);
                grid.appendChild(div);
            });

            // ★★★ 针对 Safari 的核心修复：插入数据后强制容器“抖动”一下触发重绘 ★★★
            grid.style.display = 'inline-block';
            grid.offsetHeight; 
            grid.style.display = 'block';

            masonryCursor = data.next_cursor;
            masonryHasMore = !!masonryCursor;
            if(triggerText) triggerText.innerText = masonryHasMore ? "Scroll for more" : "— End —";
        }
    } catch (e) { 
        console.error("Gallery Error:", e); 
    } finally { 
        isMasonryLoading = false; 
    }
}

        initGallery();
    </script>
<!-- Code injected by live-server -->
<script>
	// <![CDATA[  <-- For SVG support
	if ('WebSocket' in window) {
		(function () {
			function refreshCSS() {
				var sheets = [].slice.call(document.getElementsByTagName("link"));
				var head = document.getElementsByTagName("head")[0];
				for (var i = 0; i < sheets.length; ++i) {
					var elem = sheets[i];
					var parent = elem.parentElement || head;
					parent.removeChild(elem);
					var rel = elem.rel;
					if (elem.href && typeof rel != "string" || rel.length == 0 || rel.toLowerCase() == "stylesheet") {
						var url = elem.href.replace(/(&|\?)_cacheOverride=\d+/, '');
						elem.href = url + (url.indexOf('?') >= 0 ? '&' : '?') + '_cacheOverride=' + (new Date().valueOf());
					}
					parent.appendChild(elem);
				}
			}
			var protocol = window.location.protocol === 'http:' ? 'ws://' : 'wss://';
			var address = protocol + window.location.host + window.location.pathname + '/ws';
			var socket = new WebSocket(address);
			socket.onmessage = function (msg) {
				if (msg.data == 'reload') window.location.reload();
				else if (msg.data == 'refreshcss') refreshCSS();
			};
			if (sessionStorage && !sessionStorage.getItem('IsThisFirstTime_Log_From_LiveServer')) {
				console.log('Live reload enabled.');
				sessionStorage.setItem('IsThisFirstTime_Log_From_LiveServer', true);
			}
		})();
	}
	else {
		console.error('Upgrade your browser. This Browser is NOT supported WebSocket for Live-Reloading.');
	}
	// ]]>
</script>
</body>
</html>

