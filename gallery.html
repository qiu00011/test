<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visual Archive | Hyeri Fan Site</title>
    <link rel="icon" href="icon/icon.png" type="image/png">
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@300;400&family=Playfair+Display:ital,wght@0,400;0,600&display=swap" rel="stylesheet">
    
    <!-- CSS -->
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <!-- 光标 -->
    <div class="cursor-dot"></div>
    <div class="cursor-outline"></div>

    <!-- Header -->
    <header class="fixed-header">
        <div class="header-inner">
            <a href="index.html" class="logo">HYERI.</a>
            <a href="index.html" style="text-transform:uppercase; font-size:0.8rem; letter-spacing:2px;">Back Home</a>
        </div>
    </header>

    <main>
        <!-- Hero Section -->
        <section class="gallery-hero">
            <div class="container">
                <h1>Visual Archives</h1>
                <p>Curated Moments of Lee Hyeri</p>
            </div>
        </section>

        <!-- Main Content -->
        <section class="container">
            
            <!-- Slider -->
            <div class="slider-wrapper" id="sliderWrapper" style="display:none;">
                <div class="slider-track" id="sliderTrack"></div>
                <div class="slider-controls">
                    <button class="slider-btn" id="prevBtn">←</button>
                    <button class="slider-btn" id="nextBtn">→</button>
                </div>
            </div>

            <!-- Masonry Grid -->
            <div class="masonry-grid" id="masonryGrid">
                <!-- Javascript will render images here -->
            </div>

            <!-- Load More Trigger (The Sentinel) -->
            <!-- 关键修复：确保这个 div 不会跑位 -->
            <div id="loadMoreTrigger">
                <span id="triggerText">Loading Archive...</span>
            </div>

        </section>
    </main>

    <!-- Footer -->
    <footer>
        <p class="copyright">&copy; 2025 Project Hyeroomy. Unofficial Fan Site.</p>
    </footer>

    <!-- Libraries -->
    <script src="https://unpkg.com/@studio-freight/lenis@1.0.29/dist/lenis.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="js/app.js"></script>

    <!-- Gallery Specific Logic -->
    <script>
        // --- 全局配置 ---
        const CONFIG = {
            apiUrl: 'https://api.hyeri.us.kg',
            sliderFolder: '/hyerigallery/',
            masonryFolder: '/leehyeri/',
            batchSize: 12,     // 每次加载12张
            sliderDuration: 3000
        };

        // --- 状态变量 ---
        let allImages = [];
        let loadedCount = 0;
        let isBatchLoading = false;
        let observer;

        // Slider 变量
        let sliderImagesData = [];
        let currentSlide = 1;
        let slideInterval;
        const track = document.getElementById('sliderTrack');
        let isTransitioning = false;

        // --- 初始化入口 ---
        async function initGallery() {
            try {
                // 1. 获取数据
                const res = await fetch(CONFIG.apiUrl);
                const data = await res.json();
                
                if (!data.success) throw new Error("API reported failure");

                // 2. 分类
                sliderImagesData = data.images.filter(url => url.includes(CONFIG.sliderFolder));
                allImages = data.images.filter(url => url.includes(CONFIG.masonryFolder));

                // 3. 启动 Slider
                if(sliderImagesData.length > 0) initSlider();

                // 4. 启动瀑布流 (立即加载第一批)
                if(allImages.length > 0) {
                    loadNextBatch(); // 加载第一批
                    setupInfiniteScroll(); // 开启滚动监听
                } else {
                    document.getElementById('triggerText').innerText = "No images found.";
                }

            } catch (err) {
                console.error(err);
                document.getElementById('triggerText').innerText = "Failed to load gallery.";
            }
        }

        // --- 核心功能：分批加载 + 自动补全 ---
        function loadNextBatch() {
            // 如果正在加载，或者已经没有图了，直接返回
            if (isBatchLoading || loadedCount >= allImages.length) {
                if (loadedCount >= allImages.length) {
                    updateTriggerStatus("— End of Archive —");
                    if (observer) observer.disconnect();
                }
                return;
            }

            isBatchLoading = true;
            
            const grid = document.getElementById('masonryGrid');
            const batch = allImages.slice(loadedCount, loadedCount + CONFIG.batchSize);
            const fragment = document.createDocumentFragment(); // 性能优化

            batch.forEach(url => {
                const div = document.createElement('div');
                div.className = 'masonry-item';
                
                const img = document.createElement('img');
                img.src = url;
                img.loading = 'lazy'; // 原生懒加载
                
                // 图片加载完后，添加 .loaded 类实现淡入
                img.onload = () => img.classList.add('loaded');
                
                div.appendChild(img);
                fragment.appendChild(div);
            });

            grid.appendChild(fragment);
            loadedCount += batch.length;

            // 关键：给DOM渲染一点时间，然后检查是否需要加载更多
            setTimeout(() => {
                isBatchLoading = false;
                checkIfNeedsMore(); // 递归自检
            }, 500);
        }

        // --- 核心修复：检测是否填满屏幕 ---
        function checkIfNeedsMore() {
            const trigger = document.getElementById('loadMoreTrigger');
            if (!trigger) return;

            const rect = trigger.getBoundingClientRect();
            // 如果 Trigger 还在屏幕内（或者非常靠近底部），说明没填满
            // 自动加载下一批，不需要用户操作
            if (rect.top <= window.innerHeight + 100) {
                console.log("Auto-loading more images to fill screen...");
                loadNextBatch();
            }
        }

        // --- 滚动监听 ---
        function setupInfiniteScroll() {
            const trigger = document.getElementById('loadMoreTrigger');
            
            observer = new IntersectionObserver((entries) => {
                // 只要 trigger 露出一点点，并且没在加载中
                if (entries[0].isIntersecting && !isBatchLoading) {
                    loadNextBatch();
                }
            }, { 
                rootMargin: '200px', // 提前 200px 触发
                threshold: 0.1 
            });

            observer.observe(trigger);
        }

        function updateTriggerStatus(text) {
            const el = document.getElementById('triggerText');
            if(el) el.innerText = text;
        }

        // --- Slider Logic (无限轮播) ---
        function initSlider() {
            document.getElementById('sliderWrapper').style.display = 'block';
            
            const first = sliderImagesData[0];
            const last = sliderImagesData[sliderImagesData.length - 1];
            
            // 构建DOM: CloneLast + Originals + CloneFirst
            addSlideDOM(last);
            sliderImagesData.forEach(url => addSlideDOM(url));
            addSlideDOM(first);
            
            track.style.transform = `translateX(-100%)`;

            document.getElementById('nextBtn').onclick = () => { stopAuto(); nextSlide(); startAuto(); };
            document.getElementById('prevBtn').onclick = () => { stopAuto(); prevSlide(); startAuto(); };
            
            startAuto();
        }

        function addSlideDOM(url) {
            const div = document.createElement('div');
            div.className = 'slider-slide';
            div.innerHTML = `<img src="${url}" alt="Hyeri Moment">`;
            track.appendChild(div);
        }

        function nextSlide() {
            if (isTransitioning) return;
            isTransitioning = true;
            currentSlide++;
            updateTrack();
            
            track.addEventListener('transitionend', () => {
                isTransitioning = false;
                if (currentSlide === sliderImagesData.length + 1) {
                    track.style.transition = 'none';
                    currentSlide = 1;
                    track.style.transform = `translateX(-100%)`;
                }
            }, { once: true });
        }

        function prevSlide() {
            if (isTransitioning) return;
            isTransitioning = true;
            currentSlide--;
            updateTrack();

            track.addEventListener('transitionend', () => {
                isTransitioning = false;
                if (currentSlide === 0) {
                    track.style.transition = 'none';
                    currentSlide = sliderImagesData.length;
                    track.style.transform = `translateX(-${currentSlide * 100}%)`;
                }
            }, { once: true });
        }

        function updateTrack() {
            track.style.transition = 'transform 0.8s cubic-bezier(0.2, 1, 0.3, 1)';
            const slideWidth = track.parentElement.offsetWidth; // 获取精确像素宽度
            track.style.transform = `translateX(-${currentSlide * slideWidth}px)`;
        }

        function startAuto() { slideInterval = setInterval(nextSlide, CONFIG.sliderDuration); }
        function stopAuto() { clearInterval(slideInterval);
          
        }
        window.addEventListener('resize', () => {
    clearTimeout(resizeTimer);
    resizeTimer = setTimeout(() => {
        const slideWidth = track.parentElement.offsetWidth;
        track.style.transition = 'none';
        track.style.transform = `translateX(-${currentSlide * slideWidth}px)`;
    }, 100);
});

    

        // Start
        initGallery();

    </script>
</body>
</html>